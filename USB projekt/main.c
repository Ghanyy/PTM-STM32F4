#include <stdlib.h>
#include <stdio.h>
//#include "stm32f4_discovery.h"
#include "usbd_cdc_vcp.h"
#include "stm32f4xx.h"
#include "stm32f4xx_gpio.h"
#include "stm32f4xx_rcc.h"
#include "misc.h"
#include "stm32f4xx_spi.h"
#include "stm32f4xx_tim.h"
#include <string.h>

#define CMD_SET_ADC_NORMAL 0xA0
#define CMD_SET_ADC_REVERSE 0xA1
#define CMD_SET_BIAS_9 0xA2
#define CMD_SET_BIAS_7 0xA3
#define CMD_SET_POWER_CONTROL 0x28
#define CMD_SET_RESISTOR_RATIO 0x20
#define CMD_SET_VOLUME_FIRST 0x81
#define CMD_SET_VOLUME_SECOND 0
#define CMD_SET_ALLPTS_NORMAL 0xA4
#define CMD_SET_ALLPTS_ON 0xA5
#define CMD_SET_COM_NORMAL 0xC0
#define CMD_SET_COM_REVERSE 0xC8
#define CMD_DISPLAY_OFF 0xAE
#define CMD_DISPLAY_ON 0xAF
#define CMD_SET_DISP_START_LINE 0x40
#define A0_Pin GPIO_Pin_11
#define CS_Pin GPIO_Pin_9
#define RST_Pin GPIO_Pin_10
#define CMD_SET_PAGE 0xB0
#define CMD_SET_COLUMN_UPPER 0x10
#define CMD_SET_COLUMN_LOWER 0x00
#define LCDWIDTH 128
#define LCDHEIGHT 64
#define DISP_DEFAULT_BRIGHTNESS 0x0A
#define CMD_SET_PAGE 0xB0
#define CMD_RMW 0xE0
#define CMD_RMW_CLEAR 0xEE
#define CMD_SET_PAGE 0xB0
#define ST7565_STARTBYTES 0

/* Private macro */
/* Private variables */
uint32_t button_sts;
__ALIGN_BEGIN USB_OTG_CORE_HANDLE  USB_OTG_dev __ALIGN_END;
uint32_t i = 0;
/* Private function prototypes */
/* Private functions */

GPIO_InitTypeDef  GPIO_InitStructure;

extern const uint8_t font[];

const uint8_t pagemap[] = { 7, 6, 5, 4, 3, 2, 1, 0 };

uint8_t st7565_buffer[1024] = {
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

static void ST7565_updateBoundingBox(uint8_t xmin, uint8_t ymin, uint8_t xmax, uint8_t ymax) {
#ifdef enablePartialUpdate
  if (  xmin < xUpdateMin) xUpdateMin = xmin;
  if (xmax > xUpdateMax) xUpdateMax = xmax;
  if (ymin < yUpdateMin) yUpdateMin = ymin;
  if (ymax > yUpdateMax) yUpdateMax = ymax;
#endif
}

void ST7565_my_setpixel(uint8_t x, uint8_t y, uint8_t color) {
  if ((x >= LCDWIDTH) || (y >= LCDHEIGHT))
    return;

  if (color)
    st7565_buffer[x+ (y/8)*128] |= (1<<(7-(y%8)));
  else
    st7565_buffer[x+ (y/8)*128] &= ~(1<<(7-(y%8)));
}

void ST7565_fillrect(uint8_t x, uint8_t y, uint8_t w, uint8_t h, uint8_t color) {
  uint8_t i, j;

  for (i=x; i<x+w; i++) {
    for (j=y; j<y+h; j++) {
      ST7565_my_setpixel(i, j, color);
    }
  }

  ST7565_updateBoundingBox(x, y, x+w, y+h);
}

void ST7565_drawchar(uint8_t x, uint8_t line, char c) {
  uint8_t i;
  for (i =0; i<5; i++ ) {
    st7565_buffer[x + (line*128) ] = font[((unsigned char)c * 5) + i];
    x++;
  }

  ST7565_updateBoundingBox(x-5, line*8, x-1, line*8 + 8);
}

void ST7565_drawstring(uint8_t x, uint8_t line, char *c) {
  while (c[0] != 0) {
	ST7565_drawchar(x, line, c[0]);
    c++;
    x += 6;
    if (x + 6 >= LCDWIDTH) {
      x = 0;
      line++;//
    }
    if (line >= (LCDHEIGHT/8))
      return;
  }
}

void SetPin_Low(uint16_t GPIO_Pin){
	GPIO_ResetBits(GPIOB, GPIO_Pin);
}

void SetPin_High(uint16_t GPIO_Pin){
	GPIO_SetBits(GPIOB, GPIO_Pin);
}

void Delayms(vu32 nTime)
{
		TIM_TimeBaseInitTypeDef TIM_TimeBaseStructure;
	    TIM_TimeBaseStructure.TIM_Prescaler = 7200-1; // 72 MHz/7200 = 10 kHz
	    TIM_TimeBaseStructure.TIM_Period = (nTime*10); // 10000 = 1s; 10 = 1ms
	    TIM_TimeBaseStructure.TIM_CounterMode = TIM_CounterMode_Up;
	    TIM_TimeBaseStructure.TIM_ClockDivision= TIM_CKD_DIV1;
	    TIM_TimeBaseStructure.TIM_RepetitionCounter = 0;

	    TIM_TimeBaseInit(TIM2, &TIM_TimeBaseStructure);

	    TIM_Cmd(TIM2, ENABLE);

	    TIM_SetCounter(TIM2, 0);

	    while(TIM_GetFlagStatus(TIM2, TIM_FLAG_Update) == RESET);

	    TIM_Cmd(TIM2, DISABLE);
}


void SPIWrite(uint8_t B)
{
		SetPin_Low(CS_Pin);
		Delayms(10);
		while(SPI_GetFlagStatus(SPI2, SPI_FLAG_TXE) == RESET);
		SPI_SendData(SPI2, B);
		Delayms(10);
		SetPin_High(CS_Pin);
}

void display_sendData(uint8_t data)
{
SetPin_High(A0_Pin);
SPIWrite(data);
}

void display_command(uint8_t cmd) {
	SetPin_Low(A0_Pin);
	SPIWrite(cmd);
}

void ST7565_st7565_data(uint8_t c) {
  GPIO_SetBits(GPIOB, GPIO_Pin_11);

  SPIWrite(c);
}

void display_refreshAll()
{
	  uint8_t p, c;

	  for(p = 0; p < 8; p++) {
		  display_command(CMD_SET_PAGE + p);
		  display_command(CMD_SET_COLUMN_LOWER);
	      display_command(CMD_SET_COLUMN_UPPER);
	    for(c = 0; c < 132; c++) {
	      ST7565_st7565_data(0x00);
	    }
	  }
}

void ST7565_display(void) {
  uint8_t col, maxcol, p;

  for(p = 0; p < 8; p++) {
#ifdef enablePartialUpdate
    if ( yUpdateMin >= ((p+1)*8) ) {
      continue;
    }
    if (yUpdateMax < p*8) {
      break;
    }
#endif

  Delayms(1);
  display_command(CMD_SET_PAGE | pagemap[p]);
    Delayms(1);


#ifdef enablePartialUpdate
    col = xUpdateMin;
    maxcol = xUpdateMax;
#else
    col = 0;
    maxcol = LCDWIDTH;
#endif

    display_command(CMD_SET_COLUMN_LOWER | ((col+ST7565_STARTBYTES) & 0xf));
    Delayms(1);
    display_command(CMD_SET_COLUMN_UPPER | (((col+ST7565_STARTBYTES) >> 4) & 0x0F));
    Delayms(1);
    display_command(CMD_RMW);
    Delayms(1);

    for(; col < maxcol; col++) {
      ST7565_st7565_data(st7565_buffer[(128*p)+col]);
    }
  }

#ifdef enablePartialUpdate
  xUpdateMin = LCDWIDTH;// - 1;
  xUpdateMax = 0;
  yUpdateMin = LCDHEIGHT;//-1;
  yUpdateMax = 0;
#endif
}

void display_init(void)
{
		SetPin_Low(RST_Pin);
		Delayms(50);
		SetPin_High(RST_Pin);
		Delayms(50);
		display_command(CMD_SET_BIAS_7);
		Delayms(20);
		display_command(CMD_SET_ADC_REVERSE);
		Delayms(20);
		display_command(CMD_SET_COM_REVERSE);
		Delayms(20);
		display_command(CMD_SET_RESISTOR_RATIO | 0x06);
		Delayms(20);
		display_command(CMD_SET_VOLUME_FIRST);
		Delayms(20);
		display_command(CMD_SET_VOLUME_SECOND | (DISP_DEFAULT_BRIGHTNESS & 0x3f));
		Delayms(20);
		display_command(CMD_SET_POWER_CONTROL | 0x04);
		Delayms(50);
		display_command(CMD_SET_POWER_CONTROL | 0x06);
		Delayms(50);
		display_command(CMD_SET_POWER_CONTROL | 0x07);
		Delayms(50);
		display_command(CMD_SET_ALLPTS_NORMAL);
		Delayms(20);
		display_command(CMD_DISPLAY_ON);
		Delayms(20);
		display_command(CMD_SET_DISP_START_LINE);
		Delayms(20);
		display_refreshAll();
}

/**
**===========================================================================
**  Main
**===========================================================================
*/

int main(void)
{

	SystemInit();

/************************NASZE******************************/

	SystemCoreClockUpdate();
		/* Enable the SPI periph */
		RCC_APB1PeriphClockCmd(RCC_APB1Periph_SPI2,	ENABLE);
		/* Enable GPIO clocks */
		RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_GPIOB, ENABLE);
		RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM2, ENABLE);

		// SCK
		GPIO_PinAFConfig(GPIOB, GPIO_PinSource13, GPIO_AF_SPI2);
		// MISO
		GPIO_PinAFConfig(GPIOB, GPIO_PinSource14, GPIO_AF_SPI2);
		// MISO
		GPIO_PinAFConfig(GPIOB, GPIO_PinSource15, GPIO_AF_SPI2);

		GPIO_InitTypeDef GPIO_InitStructure;
		GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF;
		GPIO_InitStructure.GPIO_OType =	GPIO_OType_PP;
		GPIO_InitStructure.GPIO_PuPd = GPIO_PuPd_NOPULL;
		GPIO_InitStructure.GPIO_Speed =	GPIO_Speed_50MHz;
		GPIO_InitStructure.GPIO_Pin	= GPIO_Pin_13;
		GPIO_Init(GPIOB, &GPIO_InitStructure);
		GPIO_InitStructure.GPIO_Pin	= GPIO_Pin_15;
		GPIO_Init(GPIOB, &GPIO_InitStructure);
		GPIO_InitStructure.GPIO_Pin	= GPIO_Pin_14;
		GPIO_Init(GPIOB, &GPIO_InitStructure);


		/* SPI configuration -------------------------------------------------------*/
		SPI_InitTypeDef	SPI_InitStructure;
		SPI_I2S_DeInit(SPI2);
		SPI_InitStructure.SPI_Direction	= SPI_Direction_1Line_Tx;
		SPI_InitStructure.SPI_DataSize = SPI_DataSize_8b;
		SPI_InitStructure.SPI_CPOL	= SPI_CPOL_Low;
		SPI_InitStructure.SPI_CPHA	= SPI_CPHA_1Edge;
		SPI_InitStructure.SPI_NSS = SPI_NSS_Soft;
		SPI_InitStructure.SPI_BaudRatePrescaler	= SPI_BaudRatePrescaler_4;
		SPI_InitStructure.SPI_FirstBit = SPI_FirstBit_MSB;
		SPI_InitStructure.SPI_CRCPolynomial	= 7;
		SPI_InitStructure.SPI_Mode = SPI_Mode_Master;
		SPI_Init(SPI2, &SPI_InitStructure);


		/* Configure GPIO PIN for Lis Chip select */
		GPIO_InitStructure.GPIO_Pin	= GPIO_Pin_9 |  GPIO_Pin_10 |  GPIO_Pin_11;
		GPIO_InitStructure.GPIO_Mode = GPIO_Mode_OUT;
		GPIO_InitStructure.GPIO_OType =	GPIO_OType_PP;
		GPIO_InitStructure.GPIO_Speed =	GPIO_Speed_50MHz;
		GPIO_Init(GPIOB, &GPIO_InitStructure);

		SPI_Cmd(SPI2, ENABLE);
/*----------------------------------*/

			SetPin_Low(RST_Pin);
			SetPin_Low(A0_Pin);
			SetPin_High(CS_Pin);
			SetPin_Low(GPIO_Pin_13);
			SetPin_Low(GPIO_Pin_15);

/*************************************************/

			display_init();
			Delayms(10);
/*******************************KONIEC NASZE***********************/

	USBD_Init(&USB_OTG_dev,USB_OTG_FS_CORE_ID,&USR_desc,&USBD_CDC_cb,&USR_cb);


	int odbior = 0, czysc=0, linia=0, n=0;
	while (1){
		if(usb_cdc_kbhit())
		{
			char c;
			c = usb_cdc_getc();
			switch(c){
				case '{':
					odbior = 1;
					break;
				case '~':
					linia++;
					n=0;
					break;
				case '}':
					czysc = 1;
					break;
				case ']':
					display_refreshAll();
					break;
				default:
					if(odbior)
					{
							ST7565_drawchar(n, linia, c);
							n+=6;
					}
					break;
			}
			if(czysc)
			{
				odbior=0;
				linia=0;
				czysc=0;
				n=0;
				ST7565_display();
			}
		}
	}
}
